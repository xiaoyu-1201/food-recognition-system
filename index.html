<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>YOLOv8 é£Ÿç‰©è¾¨è­˜ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #f5f5f7; --text-color: #1d1d1f; --card-bg: #ffffff; --hover-bg: #f5f5f7;
            --border-color: #e5e5e5; --shadow: 0 2px 8px rgba(0,0,0,0.1); --secondary-text: #515154;
            --muted-text: #86868b; --border-radius: 10px; --padding: 20px; --highlight-color: #FF6384;
        }
        .dark-mode {
            --bg-color: #1d1d1f; --text-color: #f5f5f7; --card-bg: #2c2c2e; --hover-bg: #4a4a4c;
            --border-color: #4a4a4c; --secondary-text: #d1d1d6; --muted-text: #d1d1d6; --highlight-color: #FF6384;
        }
        body {
            background-color: var(--bg-color); font-family: -apple-system, BlinkMacSystemFont, "SF Pro", Arial, sans-serif;
            font-size: 16px; line-height: 1.5; color: var(--text-color); margin: 0;
        }
        .container {
            padding: var(--padding) 20px; max-width: 1400px; margin: 0 auto;
        }
        .text-center {
            display: flex; flex-direction: column; align-items: center; gap: 20px;
        }
        h2 {
            font-size: 32px; font-weight: 600; color: var(--text-color); margin: 0; white-space: normal;
            text-align: center; display: flex; align-items: center; gap: 10px;
        }
        h2::before, h2::after { content: "ğŸ±"; font-size: 32px; flex-shrink: 0; }
        h2::after { content: "ğŸœ"; }
        .header-buttons { display: flex; gap: 15px; justify-content: center; }
        .toggle-wrapper { position: relative; width: 140px; }
        .toggle-btn {
            width: 100%; border-radius: var(--border-radius); box-shadow: var(--shadow);
            background-color: var(--card-bg); border: none; font-size: 16px; font-weight: 500;
            color: var(--text-color); padding: 8px 20px; display: flex; justify-content: center;
            align-items: center; transition: all 0.2s ease;
        }
        .toggle-btn:hover { background-color: var(--hover-bg); }
        .dropdown {
            position: absolute; top: 100%; left: 0; width: 100%; background-color: var(--card-bg);
            border-radius: var(--border-radius); box-shadow: var(--shadow); display: none; z-index: 10;
            overflow: hidden; opacity: 0; transition: opacity 0.2s ease;
        }
        .dropdown.show { display: block; opacity: 1; }
        .dropdown-option {
            padding: 8px 20px; font-size: 16px; font-weight: 500; color: var(--text-color);
            text-align: center; cursor: pointer; transition: background 0.2s ease; display: flex;
            align-items: center; gap: 8px;
        }
        .dropdown-option:hover { background-color: var(--hover-bg); }
        .dropdown-option.selected { background-color: #e6f0fa; }
        .dark-mode .dropdown-option.selected { background-color: #4a4a4c; color: #f5f5f7; }
        .theme-icon { display: inline-block; width: 16px; height: 16px; border-radius: 50%; }
        .theme-icon.light { background-color: #ffffff; border: 1px solid #1d1d1f; }
        .theme-icon.dark { background-color: #1d1d1f; border: 1px solid #f5f5f7; }
        .language-icon { display: inline-block; width: 16px; height: 16px; background-size: cover; }
        .language-icon.zh-TW { background-image: url("https://flagcdn.com/16x12/tw.png"); }
        .language-icon.en { background-image: url("https://flagcdn.com/16x12/us.png"); }
        .card {
            margin-top: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow);
            border: none; background-color: var(--card-bg); padding: 15px; overflow: hidden; box-sizing: border-box;
        }
        #mainContent {
            display: flex; flex-direction: column; align-items: center; gap: 20px;
        }
        #imageArea {
            flex: 1; min-width: 400px; max-width: 100%; display: flex; align-items: center;
            justify-content: center; min-height: 400px; padding: 0; overflow: hidden; position: relative;
        }
        #previewImg:empty::before {
            content: attr(data-placeholder); color: var(--muted-text); position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 16px;
        }
        #previewImg { max-width: 100%; height: auto; border-radius: 10px; display: block; margin: 0 auto; }
        #videoStream { max-width: 100%; height: auto; border-radius: 10px; }
        #resultArea {
            min-width: 100%; max-width: 100%; display: flex; flex-direction: column;
            justify-content: center; padding: 0; margin: 0 auto; text-align: center;
        }
        .nutrition-info {
            width: 100%; max-width: 100%; padding: 20px; background-color: var(--hover-bg);
            border-radius: var(--border-radius); border: 1px solid var(--border-color);
            box-shadow: 0 1px 4px rgba(0,0,0,0.05); margin: 0 auto; box-sizing: border-box;
        }
        .nutrition-group {
            margin-top: 10px; margin-bottom: 8px; font-size: 16px; font-weight: 600;
            color: var(--text-color); border-left: 3px solid #36A2EB; padding-left: 8px;
        }
        .nutrition-info .info-item {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
            padding-bottom: 8px; gap: 10px; border-bottom: 1px solid var(--border-color);
        }
        .nutrition-info .info-item:last-child { border-bottom: none; }
        .nutrition-info .info-item .label {
            flex: 0 0 40%; font-weight: 600; color: var(--text-color); text-align: left; display: inline-block;
        }
        .nutrition-info .info-item .value {
            flex: 0 0 60%; text-align: left; color: var(--text-color); font-weight: 500;
            display: flex; align-items: center; justify-content: flex-start;
        }
        .nutrition-info .info-item .value[for="calories"] {
            font-weight: 600; color: var(--highlight-color); background-color: rgba(255, 99, 132, 0.1);
            padding: 2px 8px; border-radius: 5px; max-width: fit-content;
        }
        .nutrition-info .info-item .food-name-bold { font-weight: 600; }
        .unit-text { font-size: 12px; color: var(--muted-text); margin-left: 5px; }
        .highlight { animation: highlight 0.5s ease-in-out; }
        @keyframes highlight { 0% { opacity: 0.5; } 100% { opacity: 1; } }
        .chart-container {
            width: 100%; max-width: 400px; height: 400px; margin: 20px auto; padding: 15px;
            background-color: var(--card-bg); border-radius: var(--border-radius); box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }
        #nutritionChart { width: 100% !important; height: 100% !important; }
        .history-item {
            display: flex; align-items: center; padding: 10px 15px; margin: 5px 0;
            background-color: var(--card-bg); border-radius: var(--border-radius); box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            transition: background 0.2s ease; cursor: pointer;
        }
        .history-item:hover { background-color: var(--hover-bg); }
        .history-item .food-name { font-weight: 600; font-size: 14px; color: var(--text-color); }
        .history-item .timestamp { font-size: 12px; color: var(--muted-text); }
        .history-checkbox { margin-right: 8px; display: none; }
        .delete-mode .history-checkbox { display: inline-block !important; }
        .delete-mode .delete-btn { display: none !important; }
        .btn-sm { padding: 2px 8px; font-size: 12px; }
        #toggleDeleteMode { padding: 4px 8px !important; font-size: 14px !important; line-height: 1 !important; }
        #toggleDeleteMode i { font-size: 16px; }
        .form-label { color: var(--text-color); }
        .dark-mode .form-control { background-color: #3a3a3c; color: #f5f5f7; border-color: #4a4a4c; }
        .dark-mode .form-control::placeholder { color: #d1d1d6; }
        .dark-mode .text-secondary { color: var(--muted-text) !important; }
        .action-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        input[type="number"] { -webkit-appearance: none; -moz-appearance: textfield; appearance: none; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .portion-input-wrapper {
            position: relative; display: inline-flex; flex-direction: row; align-items: center;
            background-color: #fff; border-radius: 10px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 4px; gap: 4px; width: auto; max-width: 100px;
        }
        .dark-mode .portion-input-wrapper { background-color: #3a3a3c; box-shadow: 0 1px 3px rgba(255, 255, 255, 0.1); }
        .portion-input {
            width: 50px; padding: 4px 8px; border: none; background: transparent; font-size: 16px;
            color: var(--text-color); text-align: center; outline: none;
        }
        .portion-input-buttons { display: flex; flex-direction: column; gap: 2px; }
        .portion-input-btn {
            width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
            background-color: #f5f5f7; border-radius: 50%; cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .portion-input-btn:hover { background-color: #e5e5e5; }
        .portion-input-btn:active { transform: scale(0.95); }
        .dark-mode .portion-input-btn { background-color: #4a4a4c; }
        .dark-mode .portion-input-btn:hover { background-color: #5a5a5c; }
        .portion-input-btn i { font-size: 14px; color: #666; }
        .dark-mode .portion-input-btn i { color: #d1d1d6; }
        @media (min-width: 992px) {
            #mainContent {
                flex-direction: row;
                justify-content: space-between;
                gap: 20px;
            }
            #imageArea {
                flex: 0 0 50%;
                max-width: 50%;
            }
            #resultArea {
                flex: 0 0 45%;
                max-width: 45%;
                max-height: 600px;
                overflow-y: auto;
            }
        }
        @media (max-width: 992px) {
            #imageArea, #resultArea { max-width: 500px; width: 100%; align-self: center; }
            #imageArea { min-height: 300px; padding: 0; }
            .chart-container { max-width: 350px; height: 350px; }
            body { font-size: 14px; }
            .card { padding: 10px; margin: 10px; }
        }
        @media (max-width: 576px) {
            body { font-size: 12px; }
            h2 { font-size: 24px; }
            .nutrition-info { padding: 15px; }
            .nutrition-info .info-item { margin-bottom: 8px; }
            .nutrition-info .info-item .label, .nutrition-info .info-item .value { font-size: 14px; }
            .chart-container { max-width: 300px; height: 300px; }
            #imageArea, #resultArea { max-width: 400px; }
            #imageArea { min-height: 200px; padding: 0; }
            .portion-input-wrapper { width: auto; max-width: 80px; }
            .portion-input { width: 40px; }
            .portion-input-btn { width: 24px; height: 24px; }
            .portion-input-btn i { font-size: 12px; }
            #mainContent {
                position: relative;
            }
            #imageArea {
                position: relative;
                width: 100%;
                min-height: 60vh;
            }
            #resultArea {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                max-height: 40vh;
                overflow-y: auto;
                background: rgba(245, 245, 247, 0.9);
                padding: 10px;
                z-index: 20;
            }
            .dark-mode #resultArea {
                background: rgba(29, 29, 31, 0.9);
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="text-center mb-5">
        <h2 id="title"></h2>
        <div class="header-buttons">
            <div class="toggle-wrapper">
                <button id="themeToggle" class="toggle-btn"></button>
                <div id="themeDropdown" class="dropdown">
                    <div class="dropdown-option theme-option" data-theme="light"><span class="theme-icon light"></span><span data-key="lightTheme"></span></div>
                    <div class="dropdown-option theme-option" data-theme="dark"><span class="theme-icon dark"></span><span data-key="darkTheme"></span></div>
                </div>
            </div>
            <div class="toggle-wrapper">
                <button id="languageToggle" class="toggle-btn"></button>
                <div id="languageDropdown" class="dropdown">
                    <div class="dropdown-option language-option" data-lang="zh-TW"><span class="language-icon zh-TW"></span>ç¹é«”ä¸­æ–‡</div>
                    <div class="dropdown-option language-option" data-lang="en"><span class="language-icon en"></span>English</div>
                </div>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="mb-3">
            <label class="form-label fw-bold" id="uploadLabel">é¸æ“‡é£Ÿç‰©åœ–ç‰‡ï¼š</label>
            <input type="file" class="form-control" id="file" accept="image/*">
        </div>
        <div id="mainContent">
            <div id="imageArea" style="position: relative;">
                <video id="videoStream" autoplay playsinline style="width: 100%; height: auto; border-radius: 10px; display: none;"></video>
                <canvas id="overlayCanvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;"></canvas>
                <img id="previewImg" src="" data-placeholder="è«‹ä¸Šå‚³åœ–ç‰‡ä»¥é è¦½" style="width: 100%; height: auto; border-radius: 10px;">
                <canvas id="previewOverlayCanvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;"></canvas>
            </div>
            <div id="resultArea"></div>
        </div>
        <div class="action-buttons">
            <button id="startStreamBtn" class="btn btn-primary">é–‹å•Ÿç›¸æ©Ÿ</button>
            <button id="stopStreamBtn" class="btn btn-danger d-none">é—œé–‰ç›¸æ©Ÿ</button>
            <button id="toggleCameraBtn" class="btn btn-secondary d-none">åˆ‡æ›è‡³å‰é¡é ­</button>
            <button id="predictBtn" class="btn btn-success">ğŸ” è¾¨è­˜é£Ÿç‰©</button>
            <button id="restartStreamBtn" class="btn btn-info d-none">ğŸ”„ é‡æ–°è¾¨è­˜</button>
        </div>
        <div id="loading" class="spinner-border text-success mt-3 d-none" role="status"><span class="visually-hidden">Loading...</span></div>
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mt-4 text-secondary" id="historyTitleText">ğŸ“œ æ­·å²ç´€éŒ„</h5>
            <button id="toggleDeleteMode" class="btn btn-warning btn-sm" title="åˆªé™¤æ¨¡å¼"><i class="bi bi-trash"></i></button>
        </div>
        <button id="selectAll" class="btn btn-secondary btn-sm mb-3 d-none">å…¨é¸</button>
        <button id="confirmDelete" class="btn btn-danger btn-sm mb-3 d-none">ç¢ºèªåˆªé™¤</button>
        <input type="text" id="historySearch" class="form-control mb-2" placeholder="æœå°‹é£Ÿç‰©åç¨±">
        <div id="historyArea" class="mt-2"></div>
    </div>
    <div class="card mt-4" id="foodListArea"></div>
</div>

<script>
const translations = {
    "zh-TW": {
        "title": "YOLOv8 é£Ÿç‰©è¾¨è­˜ç³»çµ±", "uploadLabel": "é¸æ“‡é£Ÿç‰©åœ–ç‰‡ï¼š", "predictBtn": "ğŸ” è¾¨è­˜é£Ÿç‰©",
        "startStreamBtn": "é–‹å•Ÿç›¸æ©Ÿ", "stopStreamBtn": "é—œé–‰ç›¸æ©Ÿ", "restartStreamBtn": "ğŸ”„ é‡æ–°è¾¨è­˜",
        "historyTitle": "ğŸ“œ æ­·å²ç´€éŒ„", "searchPlaceholder": "æœå°‹é£Ÿç‰©åç¨±", "food_name": "ğŸ¥˜ é£Ÿç‰©åç¨±",
        "portion": "ğŸ½ï¸ ä»½é‡", "serving_size": "ğŸ½ï¸ ä»½é‡ (g)", "calories": "ğŸ”¥ ç†±é‡",
        "protein": "ğŸ’ª è›‹ç™½è³ª", "carbohydrate": "ğŸ ç¢³æ°´åŒ–åˆç‰©", "fat": "ğŸ¥‘ è„‚è‚ª",
        "dietary_fiber": "ğŸŒ¾ è†³é£Ÿçº–ç¶­", "price": "ğŸ’° åƒ¹æ ¼", "confidence": "ğŸ¯ ä¿¡å¿ƒåº¦",
        "noFood": "âš ï¸ æœªåµæ¸¬åˆ°é£Ÿç‰©ï¼", "error": "âŒ éŒ¯èª¤", "imageLoadError": "âš ï¸ åœ–ç‰‡è¼‰å…¥å¤±æ•—",
        "unknown": "æœªçŸ¥", "themeToggle": "ä¸»é¡Œ", "languageToggle": "èªè¨€", "lightTheme": "ç™½è‰²",
        "darkTheme": "é»‘è‰²", "previewPlaceholder": "è«‹ä¸Šå‚³åœ–ç‰‡ä»¥é è¦½", "basicInfo": "åŸºæœ¬è³‡è¨Š",
        "nutritionInfo": "ç‡Ÿé¤Šæˆåˆ†", "otherInfo": "å…¶ä»–è³‡è¨Š", "toggleCameraFront": "åˆ‡æ›è‡³å‰é¡é ­",
        "toggleCameraBack": "åˆ‡æ›è‡³å¾Œé¡é ­", "requestAborted": "è«‹æ±‚å·²ä¸­æ­¢ï¼Œè«‹é‡æ–°å˜—è©¦",
        "foodListTitle": "å¯è¾¨è­˜é£Ÿç‰©é …ç›®"
    },
    "en": {
        "title": "YOLOv8 Food Recognition System", "uploadLabel": "Select Food Image:", "predictBtn": "ğŸ” Recognize Food",
        "startStreamBtn": "Open Camera", "stopStreamBtn": "Close Camera", "restartStreamBtn": "ğŸ”„ Restart Recognition",
        "historyTitle": "ğŸ“œ History", "searchPlaceholder": "Search Food Name", "food_name": "ğŸ¥˜ Food Name",
        "portion": "ğŸ½ï¸ Serving Size", "serving_size": "ğŸ½ï¸ Serving Size (g)", "calories": "ğŸ”¥ Calories",
        "protein": "ğŸ’ª Protein", "carbohydrate": "ğŸ Carbohydrates", "fat": "ğŸ¥‘ Fat",
        "dietary_fiber": "ğŸŒ¾ Dietary Fiber", "price": "ğŸ’° Price", "confidence": "ğŸ¯ Confidence",
        "noFood": "âš ï¸ No Food Detected!", "error": "âŒ Error", "imageLoadError": "âš ï¸ Failed to Load Image",
        "unknown": "Unknown", "themeToggle": "Theme", "languageToggle": "Language", "lightTheme": "Light",
        "darkTheme": "Dark", "previewPlaceholder": "Please upload an image to preview", "basicInfo": "Basic Info",
        "nutritionInfo": "Nutrition Info", "otherInfo": "Other Info", "toggleCameraFront": "Switch to Front Camera",
        "toggleCameraBack": "Switch to Back Camera", "requestAborted": "Request aborted, please try again",
        "foodListTitle": "Recognizable Food Items"
    }
};

let currentLang = "zh-TW";
let currentTheme = "light";
let historyRecords = JSON.parse(localStorage.getItem('foodHistory')) || [];
let nutritionChart = null;
let isDeleteMode = false;
let portionValues = {};
let currentFacingMode = "environment";
let isDetecting = false;
let detectionInterval = null;
let stream = null;
let lastDetections = null;
let lastRecordTime = 0;
let lastNutritionUpdate = null;
const MIN_RECORD_INTERVAL = 5000;

const foodList = [
    { label: "Over-easy egg", food_name: "åŠç†Ÿå¤ªé™½è›‹" }, { label: "bawan", food_name: "è‚‰åœ“" }, { label: "beef_noodles", food_name: "ç‰›è‚‰éºµ" },
    { label: "braised_napa_cabbage", food_name: "æ»·ç™½èœ" }, { label: "braised_pork_over_rice", food_name: "æ»·è‚‰é£¯" },
    { label: "chicken_mushroom_soup", food_name: "é¦™è‡é›æ¹¯" }, { label: "chinese_pickled_cucumber", food_name: "æ¶¼æ‹Œå°é»ƒç“œ" },
    { label: "cold_noodle", food_name: "èŠéº»é†¬æ¶¼éºµ" }, { label: "deep-fried_chicken_cutlets", food_name: "ç‚¸é›æ’" },
    { label: "egg_pancake_roll", food_name: "è›‹é¤…" }, { label: "fried-spanish_mackerel_thick_soup", food_name: "åœŸé­ é­šç¾¹éºµ" },
    { label: "fried_instant_noodles", food_name: "ç‚’æ³¡éºµ" }, { label: "fried_rice_noodles", food_name: "ç‚’ç±³ç²‰" },
    { label: "loofah", food_name: "ç‚’çµ²ç“œ" }, { label: "turkey_rice", food_name: "ç«é›è‚‰é£¯" }
];

const elements = {
    title: document.getElementById("title"), uploadLabel: document.getElementById("uploadLabel"),
    predictBtn: document.getElementById("predictBtn"), startStreamBtn: document.getElementById("startStreamBtn"),
    stopStreamBtn: document.getElementById("stopStreamBtn"), restartStreamBtn: document.getElementById("restartStreamBtn"), toggleCameraBtn: document.getElementById("toggleCameraBtn"),
    historyTitleText: document.getElementById("historyTitleText"), historySearch: document.getElementById("historySearch"),
    themeToggle: document.getElementById("themeToggle"), languageToggle: document.getElementById("languageToggle"),
    toggleDeleteMode: document.getElementById("toggleDeleteMode"), confirmDelete: document.getElementById("confirmDelete"),
    selectAll: document.getElementById("selectAll"), previewImg: document.getElementById("previewImg"),
    resultArea: document.getElementById("resultArea"), videoStream: document.getElementById("videoStream"),
    historyArea: document.getElementById("historyArea"), loading: document.getElementById("loading"),
    overlayCanvas: document.getElementById("overlayCanvas"), previewOverlayCanvas: document.getElementById("previewOverlayCanvas")
};

function updateText() {
    const t = translations[currentLang];
    elements.title.textContent = t.title;
    elements.uploadLabel.textContent = t.uploadLabel;
    elements.predictBtn.textContent = t.predictBtn;
    elements.startStreamBtn.textContent = t.startStreamBtn;
    elements.stopStreamBtn.textContent = t.stopStreamBtn;
    elements.restartStreamBtn.textContent = t.restartStreamBtn;
    elements.historyTitleText.textContent = t.historyTitle;
    elements.historySearch.placeholder = t.searchPlaceholder;
    elements.themeToggle.textContent = currentTheme === "light" ? t.lightTheme : t.darkTheme;
    elements.languageToggle.textContent = currentLang === "zh-TW" ? "ç¹é«”ä¸­æ–‡" : "English";
    elements.toggleDeleteMode.innerHTML = isDeleteMode 
        ? `<i class="bi bi-x"></i>${currentLang === "en" ? " Exit" : " é€€å‡º"}` 
        : `<i class="bi bi-trash"></i>${currentLang === "en" ? " Delete" : " åˆªé™¤"}`;
    elements.confirmDelete.textContent = currentLang === "en" ? "Confirm Delete" : "ç¢ºèªåˆªé™¤";
    elements.selectAll.textContent = currentLang === "en" ? "Select All" : "å…¨é¸";
    elements.toggleCameraBtn.textContent = currentFacingMode === "environment" ? t.toggleCameraFront : t.toggleCameraBack;
    elements.previewImg.setAttribute("data-placeholder", t.previewPlaceholder);
    document.querySelectorAll('[data-key]').forEach(el => el.textContent = t[el.dataset.key]);
}

function updateTheme() {
    document.body.classList.toggle("dark-mode", currentTheme === "dark");
    if (nutritionChart) {
        nutritionChart.options.plugins.legend.labels.color = currentTheme === "dark" ? "#f5f5f7" : "#1d1d1f";
        nutritionChart.options.plugins.title.color = currentTheme === "dark" ? "#f5f5f7" : "#1d1d1f";
        nutritionChart.update();
    }
}

function updateUI() {
    updateText();
    updateTheme();
    renderFoodList();
    if (elements.resultArea.dataset.detections) {
        const data = JSON.parse(elements.resultArea.dataset.detections);
        const detectionsHtml = data.detections.map(d => renderDetection(d, portionValues[d.food_name] || 1)).join('');
        elements.resultArea.innerHTML = `
            <div class="nutrition-info">
                ${renderNutritionSelector(data.detections)}
                ${detectionsHtml}
                <div class="chart-container"><canvas id="nutritionChart"></canvas></div>
            </div>
        `;
        renderChart(data.detections);
    }
    updateHistoryUI();
}

updateUI();
elements.predictBtn.focus();

function setupDropdown(toggleId, dropdownId, optionsSelector, callback) {
    const toggle = document.getElementById(toggleId);
    const dropdown = document.getElementById(dropdownId);
    toggle.addEventListener("click", () => dropdown.classList.toggle("show"));
    dropdown.addEventListener("click", (e) => {
        const option = e.target.closest(optionsSelector);
        if (option) {
            const value = option.getAttribute(`data-${toggleId === "themeToggle" ? "theme" : "lang"}`);
            callback(value, option);
            dropdown.classList.remove("show");
            dropdown.querySelectorAll(optionsSelector).forEach(opt => opt.classList.remove("selected"));
            option.classList.add("selected");
        }
    });
}

setupDropdown("themeToggle", "themeDropdown", ".theme-option", (theme) => {
    currentTheme = theme;
    updateUI();
});

setupDropdown("languageToggle", "languageDropdown", ".language-option", (lang) => {
    currentLang = lang;
    updateUI();
});

document.addEventListener("click", (e) => {
    if (!e.target.closest(".toggle-wrapper")) {
        document.querySelectorAll(".dropdown").forEach(dropdown => dropdown.classList.remove("show"));
    }
});

function previewFile() {
    const file = document.getElementById('file').files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onloadend = () => {
        elements.previewImg.src = reader.result;
        elements.previewImg.style.display = "block";
        elements.videoStream.style.display = "none";
        elements.overlayCanvas.getContext("2d").clearRect(0, 0, elements.overlayCanvas.width, elements.overlayCanvas.height);
        elements.previewOverlayCanvas.getContext("2d").clearRect(0, 0, elements.previewOverlayCanvas.width, elements.previewOverlayCanvas.height);
    };
    reader.readAsDataURL(file);
}

function drawBoundingBoxes(detections, canvas, targetElement, sourceCanvas = null) {
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    canvas.width = targetElement.offsetWidth;
    canvas.height = targetElement.offsetHeight;

    const targetWidth = sourceCanvas ? sourceCanvas.width : targetElement.videoWidth || targetElement.width;
    const targetHeight = sourceCanvas ? sourceCanvas.height : targetElement.videoHeight || targetElement.height;
    const scaleX = canvas.width / targetWidth;
    const scaleY = canvas.height / targetHeight;

    if (!detections || !Array.isArray(detections)) return;

    detections.forEach(d => {
        if (!d.boxes || d.boxes.length !== 4) return;
        const [x, y, x2, y2] = d.boxes;
        const width = (x2 - x) * scaleX;
        const height = (y2 - y) * scaleY;
        ctx.strokeStyle = "#00FF00";
        ctx.lineWidth = 2;
        ctx.strokeRect(x * scaleX, y * scaleY, width, height);
        const foodName = currentLang === "en" ? (d.label || d.food_name).replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase()) : (d.food_name || d.label);
        const confidence = (d.confidence * 100).toFixed(2);
        ctx.font = "16px Arial";
        ctx.fillStyle = "#00FF00";
        ctx.fillRect(x * scaleX, y * scaleY - 25, ctx.measureText(`${foodName} (${confidence}%)`).width + 10, 20);
        ctx.fillStyle = "#ffffff";
        ctx.fillText(`${foodName} (${confidence}%)`, x * scaleX + 5, y * scaleY - 10);
    });
}

function renderDetection(detection, multiplier = 1) {
    const t = translations[currentLang];
    const foodName = currentLang === "en" 
        ? (detection.label || detection.food_name).replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase()) 
        : (detection.food_name || detection.label);
    const values = {
        serving_size: detection.serving_size && !isNaN(detection.serving_size) ? (detection.serving_size * multiplier).toFixed(1) : "N/A",
        calories: detection.calories && !isNaN(detection.calories) ? (detection.calories * multiplier).toFixed(2) : "N/A",
        protein: detection.protein && !isNaN(detection.protein) ? (detection.protein * multiplier).toFixed(1) : "N/A",
        carbohydrate: detection.total_carbohydrate && !isNaN(detection.total_carbohydrate) ? (detection.total_carbohydrate * multiplier).toFixed(1) : "N/A",
        fat: detection.total_fat && !isNaN(detection.total_fat) ? (detection.total_fat * multiplier).toFixed(1) : "N/A",
        dietary_fiber: detection.dietary_fiber && !isNaN(detection.dietary_fiber) ? (detection.dietary_fiber * multiplier).toFixed(1) : "N/A",
        price: detection.price && !isNaN(detection.price) ? (detection.price * multiplier).toFixed(0) : "N/A",
        confidence: (detection.confidence * 100).toFixed(2)
    };
    const priceUnit = currentLang === "en" ? "NTD" : "å…ƒ";
    return `
        <div class="nutrition-group">${t.basicInfo}</div>
        <div class="info-item">
            <span class="label">${t.food_name}</span>
            <span class="value food-name-bold">${foodName}</span>
        </div>
        <div class="info-item">
            <span class="label">${t.portion}</span>
            <span class="value">
                <span class="portion-input-wrapper">
                    <input type="number" class="portion-input" step="0.5" min="0.5" value="${multiplier}" 
                        data-food-name="${detection.food_name}" 
                        oninput="this.dataset.value = this.value; portionValues['${detection.food_name}'] = this.value" 
                        onchange="updatePortion(this, '${detection.food_name}')" 
                        onkeypress="if(event.key === 'Enter') updatePortion(this, '${detection.food_name}')">
                    <span class="portion-input-buttons">
                        <button class="portion-input-btn" onclick="adjustPortion(this, '${detection.food_name}', 0.5)"><i class="bi bi-chevron-up"></i></button>
                        <button class="portion-input-btn" onclick="adjustPortion(this, '${detection.food_name}', -0.5)"><i class="bi bi-chevron-down"></i></button>
                    </span>
                </span>
            </span>
        </div>
        <div class="info-item">
            <span class="label">${t.serving_size}</span>
            <span class="value">${values.serving_size}<span class="unit-text">${values.serving_size !== "N/A" ? " g" : ""}</span></span>
        </div>
        <div class="nutrition-group">${t.nutritionInfo}</div>
        <div class="info-item">
            <span class="label">${t.calories}</span>
            <span class="value"><span class="calories-wrapper" for="calories">${values.calories}<span class="unit-text">${values.calories !== "N/A" ? " kcal" : ""}</span></span></span>
        </div>
        <div class="info-item">
            <span class="label">${t.protein}</span>
            <span class="value">${values.protein}<span class="unit-text">${values.protein !== "N/A" ? " g" : ""}</span></span>
        </div>
        <div class="info-item">
            <span class="label">${t.carbohydrate}</span>
            <span class="value">${values.carbohydrate}<span class="unit-text">${values.carbohydrate !== "N/A" ? " g" : ""}</span></span>
        </div>
        <div class="info-item">
            <span class="label">${t.fat}</span>
            <span class="value">${values.fat}<span class="unit-text">${values.fat !== "N/A" ? " g" : ""}</span></span>
        </div>
        <div class="info-item">
            <span class="label">${t.dietary_fiber}</span>
            <span class="value">${values.dietary_fiber}<span class="unit-text">${values.dietary_fiber !== "N/A" ? " g" : ""}</span></span>
        </div>
        <div class="nutrition-group">${t.otherInfo}</div>
        <div class="info-item">
            <span class="label">${t.price}</span>
            <span class="value">${values.price}<span class="unit-text">${values.price !== "N/A" ? " " + priceUnit : ""}</span></span>
        </div>
        <div class="info-item">
            <span class="label">${t.confidence}</span>
            <span class="value">${values.confidence}<span class="unit-text">%</span></span>
        </div>
    `;
}

function adjustPortion(button, foodName, change) {
    const input = button.parentElement.parentElement.querySelector('.portion-input');
    let value = parseFloat(input.value) || 1;
    value = Math.max(0.5, value + change);
    input.value = value;
    input.dataset.value = value;
    portionValues[foodName] = value;
    updatePortion(input, foodName);
}

function renderNutritionSelector(detections) {
    return `
        <select id="nutritionSelector" class="form-select mb-3" onchange="updateChart(this.value)">
            <option value="all">${translations[currentLang].title} - ${currentLang === "en" ? "All Foods Overview" : "æ‰€æœ‰é£Ÿç‰©ç¸½è¦½"}</option>
            ${detections.map(d => `<option value="${d.food_name}">${currentLang === "en" ? (d.label || d.food_name).replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase()) : d.food_name}</option>`).join('')}
        </select>
    `;
}

function renderChart(detections) {
    const total = detections.reduce((acc, d) => {
        const m = parseFloat(document.querySelector(`input[data-food-name="${d.food_name}"]`)?.value || 1);
        return {
            protein: acc.protein + (d.protein || 0) * m,
            carbohydrate: acc.carbohydrate + (d.total_carbohydrate || 0) * m,
            fat: acc.fat + (d.total_fat || 0) * m,
            dietary_fiber: acc.dietary_fiber + (d.dietary_fiber || 0) * m
        };
    }, { protein: 0, carbohydrate: 0, fat: 0, dietary_fiber: 0 });

    const ctx = document.getElementById('nutritionChart')?.getContext('2d');
    if (ctx) {
        if (nutritionChart) nutritionChart.destroy();
        const dataValues = [total.protein, total.carbohydrate, total.fat, total.dietary_fiber];
        if (dataValues.every(val => val === 0)) return;
        nutritionChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: [translations[currentLang].protein, translations[currentLang].carbohydrate, translations[currentLang].fat, translations[currentLang].dietary_fiber],
                datasets: [{ data: dataValues, backgroundColor: ['#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'] }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: { display: true, text: translations[currentLang].nutritionInfo + 'ï¼ˆç¸½é‡ï¼‰', color: currentTheme === "dark" ? "#f5f5f7" : "#1d1d1f" },
                    legend: { position: 'bottom', labels: { boxWidth: 15, font: { size: 14 }, color: currentTheme === "dark" ? "#f5f5f7" : "#1d1d1f" } },
                    tooltip: { callbacks: { label: context => `${context.label}: ${context.raw.toFixed(1)} g` } }
                }
            }
        });
    }
}

function updateChart(selectedFood) {
    const data = JSON.parse(elements.resultArea.dataset.detections);
    const filteredDetections = selectedFood === "all" ? data.detections : data.detections.filter(d => d.food_name === selectedFood);
    renderChart(filteredDetections);
}

function updatePortion(input, foodName) {
    let multiplier = parseFloat(input.value);
    if (isNaN(multiplier) || multiplier < 0.5) multiplier = 0.5;
    input.value = multiplier;
    portionValues[foodName] = multiplier;
    const currentData = JSON.parse(elements.resultArea.dataset.detections);
    const updatedHtml = currentData.detections.map(d => 
        d.food_name === foodName ? renderDetection(d, multiplier) : renderDetection(d, portionValues[d.food_name] || 1)
    ).join('');
    elements.resultArea.innerHTML = `
        <div class="nutrition-info">
            ${renderNutritionSelector(currentData.detections)}
            ${updatedHtml}
            <div class="chart-container"><canvas id="nutritionChart"></canvas></div>
        </div>
    `;
    const updatedElements = elements.resultArea.querySelectorAll('.value');
    updatedElements.forEach(el => el.classList.add('highlight'));
    renderChart(currentData.detections);
}

async function predictImage() {
    const fileInput = document.getElementById("file");
    if (fileInput.files.length === 0) {
        alert(translations[currentLang].uploadLabel);
        return;
    }
    const formData = new FormData();
    formData.append("image", fileInput.files[0]);
    elements.loading.classList.remove("d-none");
    try {
        const response = await fetch("https://food-backend-1oar.onrender.com/predict", { method: "POST", body: formData, mode: "cors", signal: AbortSignal.timeout(10000) });
        if (!response.ok) throw new Error(`ä¼ºæœå™¨éŒ¯èª¤ï¼š${response.statusText}`);
        const data = await response.json();
        if (!data.detections || data.detections.length === 0) {
            elements.resultArea.innerHTML = `<div class="alert alert-warning">${translations[currentLang].noFood}</div>`;
            return;
        }
        elements.previewImg.src = data.image_url;
        elements.previewImg.style.display = "block";
        elements.videoStream.style.display = "none";
        const detectionsHtml = data.detections.map(d => renderDetection(d)).join('');
        elements.resultArea.innerHTML = `
            <div class="nutrition-info">
                ${renderNutritionSelector(data.detections)}
                ${detectionsHtml}
                <div class="chart-container"><canvas id="nutritionChart"></canvas></div>
            </div>
        `;
        elements.resultArea.dataset.detections = JSON.stringify(data);
        renderChart(data.detections);
        elements.previewImg.onload = () => {
            elements.previewOverlayCanvas.width = elements.previewImg.offsetWidth;
            elements.previewOverlayCanvas.height = elements.previewImg.offsetHeight;
            drawBoundingBoxes(data.detections, elements.previewOverlayCanvas, elements.previewImg);
        };
        const record = { timestamp: new Date().toLocaleString(), detections: data.detections, image_url: data.image_url };
        historyRecords.push(record);
        localStorage.setItem('foodHistory', JSON.stringify(historyRecords));
        updateHistoryUI();
    } catch (err) {
        const errorMsg = err.message.includes("Failed to fetch") ? "ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ä¼ºæœå™¨ç‹€æ…‹" : err.message;
        elements.resultArea.innerHTML = `<div class="alert alert-danger">${translations[currentLang].error}ï¼š${errorMsg}</div>`;
        console.error("éŒ¯èª¤:", err);
    } finally {
        elements.loading.classList.add("d-none");
    }
}

function renderFoodList() {
    const foodListHtml = foodList.map(food => `
        <li>${currentLang === "en" ? food.label.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase()) : food.food_name}</li>
    `).join('');
    document.getElementById("foodListArea").innerHTML = `<h5>${translations[currentLang].foodListTitle}</h5><ul>${foodListHtml}</ul>`;
}

function updateHistoryUI() {
    elements.historyArea.innerHTML = historyRecords.map((record, index) => `
        <div class="history-item ${isDeleteMode ? 'delete-mode' : ''}" data-index="${index}">
            <input type="checkbox" class="history-checkbox" data-index="${index}">
            <span>
                <span class="food-name">${record.detections.map(d => currentLang === "en" ? (d.label || d.food_name).replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase()) : (d.food_name || d.label)).join(', ')}</span>
                <span class="timestamp"> - ${record.timestamp}</span>
            </span>
        </div>
    `).join('');
}

function showHistoryDetail(index) {
    const record = historyRecords[index];
    const detectionsHtml = record.detections.map(d => renderDetection(d, portionValues[d.food_name] || 1)).join('');
    elements.resultArea.innerHTML = `
        <div class="nutrition-info">
            ${renderNutritionSelector(record.detections)}
            ${detectionsHtml}
            <div class="chart-container"><canvas id="nutritionChart"></canvas></div>
        </div>
    `;
    elements.videoStream.style.display = "none";
    elements.previewImg.src = record.image_url;
    elements.previewImg.style.display = "block";
    elements.previewImg.onload = () => {
        elements.previewOverlayCanvas.width = elements.previewImg.offsetWidth;
        elements.previewOverlayCanvas.height = elements.previewImg.offsetHeight;
        drawBoundingBoxes(record.detections, elements.previewOverlayCanvas, elements.previewImg);
    };
    elements.resultArea.dataset.detections = JSON.stringify(record);
    renderChart(record.detections);
}

function filterHistory() {
    const query = elements.historySearch.value.toLowerCase();
    const filtered = historyRecords.filter(record => 
        record.detections.some(d => 
            (currentLang === "en" ? (d.label || d.food_name) : (d.food_name || d.label)).toLowerCase().includes(query)
        )
    );
    elements.historyArea.innerHTML = filtered.map(record => {
        const originalIndex = historyRecords.indexOf(record);
        return `
            <div class="history-item ${isDeleteMode ? 'delete-mode' : ''}" data-index="${originalIndex}">
                <input type="checkbox" class="history-checkbox" data-index="${originalIndex}">
                <span>
                    <span class="food-name">${record.detections.map(d => currentLang === "en" ? (d.label || d.food_name).replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase()) : (d.food_name || d.label)).join(', ')}</span>
                    <span class="timestamp"> - ${record.timestamp}</span>
                </span>
            </div>
        `;
    }).join('');
}

function toggleCheckbox(event, index) {
    if (!isDeleteMode) {
        showHistoryDetail(index);
        return;
    }
    const target = event.target;
    if (target.classList.contains('delete-btn') || target.tagName === 'BUTTON') return;
    const checkbox = document.querySelector(`.history-checkbox[data-index="${index}"]`);
    checkbox.checked = !checkbox.checked;
}

function toggleDeleteMode() {
    isDeleteMode = !isDeleteMode;
    elements.toggleDeleteMode.innerHTML = isDeleteMode 
        ? `<i class="bi bi-x"></i>${currentLang === "en" ? " Exit" : " é€€å‡º"}` 
        : `<i class="bi bi-trash"></i>${currentLang === "en" ? " Delete" : " åˆªé™¤"}`;
    elements.confirmDelete.classList.toggle("d-none", !isDeleteMode);
    elements.selectAll.classList.toggle("d-none", !isDeleteMode);
    updateHistoryUI();
}

function confirmDelete() {
    const selectedIndexes = Array.from(document.querySelectorAll('.history-checkbox:checked'))
        .map(checkbox => parseInt(checkbox.dataset.index))
        .sort((a, b) => b - a);
    if (selectedIndexes.length === 0) {
        alert(currentLang === "en" ? "Please select at least one record to delete." : "è«‹è‡³å°‘é¸æ“‡ä¸€ç­†ç´€éŒ„é€²è¡Œåˆªé™¤ã€‚");
        return;
    }
    const confirmMsg = currentLang === "en" 
        ? `Are you sure you want to delete ${selectedIndexes.length} record(s)?` 
        : `ç¢ºå®šè¦åˆªé™¤ ${selectedIndexes.length} ç­†ç´€éŒ„å—ï¼Ÿ`;
    if (confirm(confirmMsg)) {
        selectedIndexes.forEach(index => historyRecords.splice(index, 1));
        localStorage.setItem('foodHistory', JSON.stringify(historyRecords));
        toggleDeleteMode();
    }
}

elements.toggleDeleteMode.addEventListener("click", toggleDeleteMode);
elements.confirmDelete.addEventListener("click", confirmDelete);
elements.selectAll.addEventListener("click", () => {
    document.querySelectorAll('.history-checkbox').forEach(checkbox => checkbox.checked = true);
});
elements.historySearch.addEventListener("keyup", filterHistory);
elements.historyArea.addEventListener("click", (e) => {
    const item = e.target.closest(".history-item");
    if (item) toggleCheckbox(e, parseInt(item.dataset.index));
});

document.getElementById("file").addEventListener("change", previewFile);

let canvas = document.createElement("canvas");

async function startCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode } });
        elements.videoStream.srcObject = stream;
        elements.videoStream.play();
        elements.startStreamBtn.classList.add("d-none");
        elements.stopStreamBtn.classList.remove("d-none");
        elements.toggleCameraBtn.classList.remove("d-none");
        elements.predictBtn.classList.add("d-none");
        elements.restartStreamBtn.classList.add("d-none");
        elements.previewImg.style.display = "none";
        elements.videoStream.style.display = "block";
        elements.videoStream.addEventListener("loadedmetadata", () => {
            canvas.width = elements.videoStream.videoWidth;
            canvas.height = elements.videoStream.videoHeight;
            elements.overlayCanvas.width = elements.videoStream.offsetWidth;
            elements.overlayCanvas.height = elements.videoStream.offsetHeight;
            startDetection();
        });
    } catch (err) {
        console.error("ç„¡æ³•å­˜å–ç›¸æ©Ÿ:", err);
        alert("ç„¡æ³•å­˜å–ç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥æ¬Šé™æˆ–è¨­å‚™æ˜¯å¦æ”¯æ´ï¼");
    }
}

async function startDetection() {
    if (isDetecting) return;
    isDetecting = true;
    const DETECTION_INTERVAL = 2000;
    let lastFrameDetections = null;

    function drawLiveOverlay() {
        if (lastDetections && JSON.stringify(lastDetections) !== JSON.stringify(lastFrameDetections)) {
            drawBoundingBoxes(lastDetections, elements.overlayCanvas, elements.videoStream, canvas);
            lastFrameDetections = [...lastDetections];
        }
        if (isDetecting) requestAnimationFrame(drawLiveOverlay);
    }
    requestAnimationFrame(drawLiveOverlay);

    detectionInterval = setInterval(async () => {
        if (!isDetecting) {
            clearInterval(detectionInterval);
            return;
        }
        const currentTime = Date.now();
        if (currentTime - lastRecordTime < MIN_RECORD_INTERVAL) return;

        canvas.getContext("2d").drawImage(elements.videoStream, 0, 0, canvas.width, canvas.height);
        const imageDataUrl = canvas.toDataURL("image/jpeg");
        const blob = await (await fetch(imageDataUrl)).blob();
        const formData = new FormData();
        formData.append("image", blob, "frame.jpg");
        elements.loading.classList.remove("d-none");

        try {
            const response = await fetch("https://food-backend-1oar.onrender.com/predict", { method: "POST", body: formData, mode: "cors" });
            if (!response.ok) throw new Error(`ä¼ºæœå™¨éŒ¯èª¤ï¼š${await response.text()}`);
            const data = await response.json();
            lastDetections = data.detections || [];
            if (!lastDetections.length) {
                elements.resultArea.innerHTML = `<div class="alert alert-warning">${translations[currentLang].noFood}</div>`;
            } else {
                const detectionsHtml = lastDetections.map(d => renderDetection(d)).join('');
                elements.resultArea.innerHTML = `
                    <div class="nutrition-info">
                        ${renderNutritionSelector(lastDetections)}
                        ${detectionsHtml}
                        <div class="chart-container"><canvas id="nutritionChart"></canvas></div>
                    </div>
                `;
                elements.resultArea.dataset.detections = JSON.stringify({ detections: lastDetections });
                renderChart(lastDetections);
                lastRecordTime = currentTime;
                const record = { timestamp: new Date().toLocaleString(), detections: lastDetections, image_url: imageDataUrl };
                historyRecords.push(record);
                localStorage.setItem('foodHistory', JSON.stringify(historyRecords));
                updateHistoryUI();
            }
        } catch (err) {
            elements.resultArea.innerHTML = `<div class="alert alert-danger">${translations[currentLang].error}ï¼š${err.message}</div>`;
            console.error("éŒ¯èª¤:", err);
        } finally {
            elements.loading.classList.add("d-none");
        }
    }, DETECTION_INTERVAL);
}

elements.startStreamBtn.addEventListener("click", startCamera);

elements.toggleCameraBtn.addEventListener("click", () => {
    currentFacingMode = currentFacingMode === "environment" ? "user" : "environment";
    updateText();
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        startCamera();
    }
});

elements.restartStreamBtn.addEventListener("click", () => {
    elements.videoStream.style.display = "block";
    elements.previewImg.style.display = "none";
    elements.previewOverlayCanvas.getContext("2d").clearRect(0, 0, elements.previewOverlayCanvas.width, elements.previewOverlayCanvas.height);
    isDetecting = false;
    clearInterval(detectionInterval);
    startDetection();
    elements.restartStreamBtn.classList.add("d-none");
});

elements.stopStreamBtn.addEventListener("click", () => {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
        elements.videoStream.srcObject = null;
        isDetecting = false;
        clearInterval(detectionInterval);
        elements.overlayCanvas.getContext("2d").clearRect(0, 0, elements.overlayCanvas.width, elements.overlayCanvas.height);
        elements.previewOverlayCanvas.getContext("2d").clearRect(0, 0, elements.previewOverlayCanvas.width, elements.previewOverlayCanvas.height);
        elements.startStreamBtn.classList.remove("d-none");
        elements.stopStreamBtn.classList.add("d-none");
        elements.toggleCameraBtn.classList.add("d-none");
        elements.predictBtn.classList.remove("d-none");
        elements.restartStreamBtn.classList.add("d-none");
        elements.previewImg.style.display = "block";
        elements.videoStream.style.display = "none";
        elements.resultArea.innerHTML = "";
    }
});

elements.predictBtn.addEventListener("click", predictImage);

document.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.keyCode === 13) {
        e.preventDefault();
        elements.predictBtn.click();
    }
});
</script>
</body>
</html>
